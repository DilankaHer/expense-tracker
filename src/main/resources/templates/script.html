<script>
    let categories = [];
    async function handleCategoryChange(el) {
        if (categories.length == 0) {
            await fetch("/categoriesJSON").then(res => res.json()).then(data => {
                if (data && data.length > 0) {
                    categories = data
                }
            });
        }

        const icon = document.getElementById("form-category-icon-value").value;
        for (let i = 0; i < categories.length; i++) {
            if (categories[i].name == el.value || (categories[i].name == "Others" && icon != "category-others")) {
                fetch("/category?name=" + categories[i].name + "&icon=" + categories[i].icon).then(res => res.text()).then(data => {
                    document.getElementById("form-category-icon").innerHTML = data;
                    document.getElementById("form-category-icon-value").value = categories[i].icon;
                    document.getElementById("form-subCategory").value = "";
                });
                break;
            }
        }
    }
    function selectCategory(el) {
        const svg = el.querySelector("svg");
        document.getElementById("form-category").value = el.dataset.category;
        document.getElementById("form-category-icon").innerHTML = svg.outerHTML;
        document.getElementById("form-category-icon-value").value = el.dataset.icon;
        document.getElementById("categorySelection").innerHTML = '';

        document.getElementById("form-subCategory").value = "";
    }
    function selectSubCategory(el) {
        console.log(el);
        const svg = el.querySelector("svg");
        console.log(svg);
        document.getElementById("form-subCategory").value = el.dataset.subcategory;
        document.getElementById("form-subCategory-icon").innerHTML = svg.outerHTML;
        document.getElementById("form-subCategory-icon-value").value = el.dataset.icon;
        document.getElementById("subCategorySelection").innerHTML = '';
    }
    document.addEventListener('DOMContentLoaded', (event) => {
        const home = document.getElementById("home");
        const transactions = document.getElementById("transactions");
        home.classList.add("pressed");
        home.addEventListener("click", () => {
            home.classList.add("pressed");
            transactions.classList.remove("pressed");
        });
        transactions.addEventListener("click", () => {
            transactions.classList.add("pressed");
            home.classList.remove("pressed");
        });

        document.addEventListener("htmx:afterSwap", (el) => {
            if (el.detail.pathInfo.finalRequestPath == "/tab?tab=transactions") {
                const currentDate = new Date()
                let month = currentDate.toLocaleString('default', { month: 'short' })
                let year = currentDate.toLocaleString('default', { year: 'numeric' })
                let offset = 0
                function updateMonthYear(action) {
                    action == "prev" ? offset -= 1 : offset += 1
                    const date = new Date()
                    date.setMonth(date.getMonth() + offset)
                    month = date.toLocaleString('default', { month: 'short' })
                    year = date.toLocaleString('default', { year: 'numeric' })
                    document.getElementById("myp-month-year").innerHTML = month + ", " + year
                    document.getElementById("myp-month").value = date.getMonth() + 1
                    document.getElementById("myp-year").value = date.getFullYear()
                }
                document.getElementById("myp-month-year").innerHTML = month + ", " + year
                document.getElementById("myp-month").value = currentDate.getMonth() + 1
                document.getElementById("myp-year").value = currentDate.getFullYear()

                document.getElementById("myp-prev").addEventListener("click", () => {
                    updateMonthYear("prev")
                    document.getElementById("myp-next").removeAttribute("disabled")
                })

                document.getElementById("myp-next").addEventListener("click", () => {
                    updateMonthYear("next")
                    if (offset == 0) {
                        document.getElementById("myp-next").setAttribute("disabled", "disabled")
                    }
                })
            }
            // Reinitialize popover handlers after HTMX swaps
            initializePopoverHandlers();
        })

        // Intercept htmx:confirm to show custom dialog
        document.body.addEventListener('htmx:confirm', function (e) {
            console.log("sdasds", e);
            if (e.detail.question) { // Check if hx-confirm attribute is present
                e.preventDefault(); // Prevent the default htmx request
                Swal.fire({
                    title: 'Confirm Action',
                    text: e.detail.question, // Use the value from hx-confirm
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Delete',
                    background: '#2f314a',
                    color: '#f5f5f5',
                }).then((result) => {
                    if (result.isConfirmed) {
                        e.detail.issueRequest(true); // Manually issue the request, skipping default confirm
                    }
                });
            }
        });
    });

    // Popover functionality
    let currentPopover = null;
    let popoverClickHandler = null;

    function showDescriptionPopover(event, element) {
        event.stopPropagation();

        // Get popover ID from data attribute
        const popoverId = element.getAttribute('data-popover-id');
        if (!popoverId) return;

        const popover = document.getElementById(popoverId);
        if (!popover) return;

        // Close any existing popover
        if (currentPopover && currentPopover !== popover) {
            currentPopover.classList.add('hidden');
        }

        // Toggle current popover
        if (popover.classList.contains('hidden')) {
            popover.classList.remove('hidden');
            currentPopover = popover;
        } else {
            popover.classList.add('hidden');
            currentPopover = null;
        }
    }

    function initializePopoverHandlers() {
        // Remove existing click handler if any
        if (popoverClickHandler) {
            document.removeEventListener('click', popoverClickHandler);
        }

        // Close popover when clicking outside
        popoverClickHandler = function (event) {
            if (currentPopover) {
                const isClickInsidePopover = currentPopover.contains(event.target);
                const isClickOnTrigger = event.target.closest('[data-popover-id]') !== null;

                if (!isClickInsidePopover && !isClickOnTrigger) {
                    currentPopover.classList.add('hidden');
                    currentPopover = null;
                }
            }
        };

        document.addEventListener('click', popoverClickHandler);
    }

    // Initialize on page load
    initializePopoverHandlers();
</script>